# 组原课设学习笔记

## 流水线冲突

**指令相关**：两条指令之间存在依赖关系，会导致**流水线冲突/冒险（Hazzard）**

- 数据相关 -> **数据冲突**
  - 当前指令要用到先前指令的操作结果，但这个结果还没产生或送达
  - 包括先写后读冲突（RAW）、先读后写冲突（WAR）、写后写冲突（WAW）
    - RAW：I2的源操作数是I1的目的操作数
    - WAR：I2的目的操作数是I1的源操作数
    - WAW：I2和I1的目的操作数相同
- 结构相关 -> **结构/资源冲突**
  - 多条指令在同一周期需要使用同一部件
  - 在MIPS中不存在
  - 解决：增加部件/插入气泡
- 控制相关 -> **控制冲突**
  - 由于分支的目标地址需要到EX段才能确认，途中取出的后续指令不应进入执行阶段，应该清除
  - **解决：确定执行分支指令时清空前两个流水寄存器**



## 气泡法解决数据冲突

什么是气泡：为了消除相关性插入的空指令

只需要考虑ID段指令与后续三段（EX、MEM、WB）里存储的指令之间的数据相关性

- ID与WB段的数据相关可以用先写后读的方式解决，即寄存器堆写入采用下跳沿触发，而所有流水寄存器采用上跳沿触发（假设中间是低电平，即从1开始0结束）
- ID与EX、MEM两段的数据相关
  - 检测数据相关性硬件逻辑
    - 要确认ID指令使用的源寄存器是否在EX、MEM中写入，只需要检查EX、MEM段的RegWrite是否为1且写入编号是否相同
  - 气泡插入逻辑
    - 插入气泡：使用Flush
    - 暂停IF、ID：保持PC、IF/ID流水寄存器的值不变 -> 控制寄存器使能端



## 重定向法解决冲突

气泡法插入空指令和控制节拍来达到冲突解决的途径会导致性能损失。

实际冲突指令中滞后未能到达的数据只是未能写回，其实际已经完成运算，存储在对应的流水寄存器中，可以通过重定向/旁路的方法获得。

**注意：如果相邻两条指令存在数据相关，且前一条指令是访存指令时（称为Load-Use 相关），这种数据相关并不能采用重定向方式进行处理**。因此访存指令必须在两条相邻指令之间强制插入一个气泡来实现。
